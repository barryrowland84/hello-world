version: 2.1

working_directory: &working_directory "~/repo"

orbs:
  gcr: circleci/gcp-gcr@0.15.1
  google-oidc: solidblocks/google-oidc@0.0.5

jobs:
  build-push-image:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true

    working_directory: *working_directory

    docker:
      - image: cimg/base:current

    steps:
      - checkout
      - google-oidc/authenticate

      - run:
          name: Setup docker credentials
          command: gcloud auth configure-docker
      
      - run:
          name: "Build"
          command: docker build -t gcr.io/spherical-plane-479301-d5/hello-world:1.0.0

      - gcr/push-image:
          registry-url: gcr.io
          image: hello-world
          tag: 1.0.0

workflows:
  build:
    jobs:
      - build-push-image:
          context:
            - gcp
          filters:
            branches:
              only:
                - main