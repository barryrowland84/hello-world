version: 2.1

working_directory: &working_directory "~/repo"

orbs:
  gcr: circleci/gcp-gcr@0.15.1
  google-oidc: solidblocks/google-oidc@0.0.5

jobs:
  build-push-image:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true

    working_directory: *working_directory

    steps:
      - checkout
      - google-oidc/authenticate
      - run:
          name: Setup docker credentials
          command: gcloud auth configure-docker

      - run:
          name: Show the credentials
          command: |
            NEW_AUDIENCE="//iam.googleapis.com/projects/192970750220/locations/global/workloadIdentityPools/alexdev-pool/providers/alexdev-provider"
            jq --arg AUD "$NEW_AUDIENCE" '.audience = $AUD' /home/circleci/gcp_cred_config.json > /home/circleci/gcp_cred_config.json.tmp && mv /home/circleci/gcp_cred_config.json.tmp /home/circleci/gcp_cred_config.json
            gcloud auth list
      

      - run:
          name: Same show credentials
          command: cat $GOOGLE_APPLICATION_CREDENTIALS | head

      - run:
          name: "Build with gcr url"
          command: docker build -t gcr.io/spherical-plane-479301-d5/hello-world:1.2.0 .

      - run:
          name: "Push the docker image"
          command: docker push gcr.io/spherical-plane-479301-d5/hello-world:1.1.0

      # - run:
      #   name: "Push the docker image"
      #   command: docker build -t gcr.io/${GOOGLE_PROJECT_ID}/hello-world:1.2.0


      # - gcr/push-image:
      #     registry-url: gcr.io
      #     image: hello-world
      #     tag: "1.1.0"

workflows:
  build:
    jobs:
      - build-push-image:
          context:
            - gcp
          filters:
            branches:
              only:
                - main